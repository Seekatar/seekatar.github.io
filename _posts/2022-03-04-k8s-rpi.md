---
# author: seekatar
title: Creating a Kubernetes Environment on Raspberry Pis
tags:
 - docker
 - dotnet
 - helm
 - kubernetes
 - raspberrypi
excerpt: Install Docker, Docker Registry, Kubernetes on Raspberry Pis
cover: /assets/images/autumn-leaves-5-1385725.jpg
comments: true
layout: article
key: rpik8s-1
---

![image]({{ page.cover }}){: width="{{ site.imageWidth }}" }

## Another Blog about Raspberry Pi and Kubernetes?!

This is yet another blog about someone installing Kubernetes (K8s) on Raspberry Pis. Most of the blogs I found are focused on the IT side and deploying existing images, but as a developer I wanted to create a cluster to build and deploy my own .NET apps on the Pi. I'm sleeping on the shoulders of giants, and have provided many of the links I found useful at the [end](#links).

> All of the scripts and code for this are available in this [GitHub repo]( https://github.com/Seekatar/dotnet-webapi.git). There are a bunch of words in this post, but there's a checklist [here]().

I used a Windows box for development, but everything here should run on Linux or a Mac. Some of the script snippets are in PowerShell, which can easily be ported to another scripting language (PowerShell runs nicely on Linux and Mac.)

If you're only interested in trying K8s and Helm locally, you can do all that with [Docker Desktop](https://www.docker.com/products/docker-desktop), [Podman](https://podman.io/), or [Rancher Desktop](https://rancherdesktop.io/).

## Creating the Cluster

You can install full K8s or Rancher's K3s, which is a lightweight flavor of K8s. I chose to install K3s and it went quite smoothly following [Rancher's quick start page](https://rancher.com/docs/k3s/latest/en/quick-start/)

To test out K8s, I wanted at least two nodes to for scaling and to test pulling images onto multiple nodes from a local Docker Registry.

### Pi Hardware

I first started out trying to deploy to the following Pis I had lying around (it's very hard to get new ones now).

* Raspberry Pi 2B for the control plane and worker üòÑ
* Raspberry Pi B for a worker üò¢
* Raspberry Pi ZeroW for a worker üò¢

The deployment went well, but when running on the B and Zero I got an `illegal instruction` error. Googling, I found that the 2B is the minimum Pi hardware for K8s, so I had to switch to plan 4B. I had a couple of 3Bs in use, and a 4B that I was saving for other projects, but since it's so easy to switch SD cards, I decided to use the 4B and 2B.

* Raspberry Pi 4B for the control plane and worker (hostname = `k3s-server`) üòÑ
* Raspberry Pi 2B for a worker (hostname = `k3s-worker-1`) üòÑ

### Windows

The Pis will be headless, so I used a Windows 10 box to run docker, kubectl, and helm clients as well as ssh to access them as needed. Some of the applications I used on the developer box are as follows:

* OpenSSH Client is enabled.
  * Open Settings (Win+I)->Apps->Optional Features and search for SSH to find the `OpenSSH Client`
  * All you need is the client. When Googling SSH, you probably don't need the server running locally.
  * If you don't already have an ssh key pair, you'll need to generate a set that you can use for accessing the Pis.
* Docker Desktop for WSL 2, which installs docker and kubectl apps. For this scenario, I stopped Docker Desktop on Windows to avoid getting confused as to which one I was hitting.
* helm.exe, which can be downloaded from [here](https://github.com/helm/helm/releases) or with `Install-Package`
* [.NET 6](https://dotnet.microsoft.com/en-us/download/dotnet/6.0)
* [Visual Studio Code](https://code.visualstudio.com/download).
  * Docker extension from MS
  * Kubernetes extension from MS
  * C# extension from MS
* [Lens](https://k8slens.dev/)

In this scenario, I wasn't writing code that was on the Pis, but some great VSCode extensions are the Remote-* extensions from MS that allow you to run VSCode locally but use files and a prompt on the remote machine. You can even debug!

### Raspberry Pi OS Setup

This is the common setup for all the K8s nodes.

I used the relatively new Raspberry Pi Imager tool from the Raspberry Pi [site](https://www.raspberrypi.com/software/). Since they will be headless, I chose the `Raspberry Pi OS Lite(32-bit)` Bullseye port from 2022-01-18. One of the nice things about the Imager is that you can do much of the configuration when building the image instead of manually after boot. I clicked the gear in the lower right to access the Advanced Options.

![rpi-imager](/assets/images/rpi-imager.png)

I then updated these settings:

* Set hostname
* Enable SSH and set the public key I created on the Windows box
* Set username and password
* Configure wifi
* Set locale settings

![rpi-imager-options](/assets/images/rpi-imager-options.png)

After booting up, I set a static IP per the [Raspberry Pi directions](https://forums.raspberrypi.com/viewtopic.php?t=205276), which says to edit `/etc/dhcpcd.conf`. The file will have several examples commented out. My Pis are wired so I uncommented out the `eth0` block and updated the values to look like this. I have the DHCP server in my router only server up to 199 so I can use static IPs 200-255.

```text
interface eth0
static ip_address=192.168.1.200/24
#static ip6_address=fd51:42f8:caae:d92e::ff/64
static routers=192.168.1.1
static domain_name_servers=192.168.1.1 8.8.8.8
```

K3s also needs a configuration tweak. Edit `/boot/cmdline.txt` and add `cgroup_memory=1 cgroup_enable=memory` to the end of the first line. (If you don't K3s will tell you to do it when it fails to start.) Mine looks like this now:

```text
console=serial0,115200 console=tty1 root=PARTUUID=a48fb9ae-02 rootfstype=ext4 fsck.repair=yes rootwait cgroup_memory=1 cgroup_enable=memory
```

You've may have read that K8s doesn't like to have swap turned on, so it's best to turn it off on each node. `k3s check-config` will warn you about it.

```bash
sudo service dphys-swapfile stop
sudo systemctl disable dphys-swapfile.service
```

### Installing K3s on the Server

[Rancher's quick start](https://rancher.com/docs/k3s/latest/en/quick-start/) makes it pretty easy by having a script you can download and run to install K3s.

```bash
curl -sfL https://get.k3s.io | sh -
```

For the workers, you need to get the server's token which is in `/var/lib/rancher/k3s/server/node-token`

For connecting to the cluster with `kubectl` or tools like [Lens](https://k8slens.dev/) from another machine, grab the config from `/etc/rancher/k3s/k3s.yaml`. I copied t to `~/.kube/k3s-config` on Windows. After copying it, edit it to change the `server` value from `localhost` as shown in the snippet below

```text
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: ...
    server: https://k3s-server:6443 <<< change to server name from 127.0.0.1
  name: default
...
```

### Installing K3s on a Worker

Again, [Rancher's quick start](https://rancher.com/docs/k3s/latest/en/quick-start/) makes it pretty to do for the workers, too.

```bash
export K3S_TOKEN="<token from server's /var/lib/rancher/k3s/server/node-token>"
export K3S_SERVER="https://<server's static ip>:6443"
curl -sfL https://get.k3s.io | K3S_URL=$K3S_SERVER K3S_TOKEN=$K3S_TOKEN sh -
```

### Verifying the Install

At this point, the cluster should be up and running. You can run some `kubectl` commands to verify it. You can run these on the server, or on an machine with `kubectl` using the config pulled from the server (and the `server` value edited).

```bash
kubectl version
kubectl cluster-info
kubectl get nodes -o wide
```

On each node, you can view the logs for K3s with this command if you are having issues.

```bash
journalctl -u k3s # view logs
```

You can also check the K3s configuration. I get some errors about some environment variables and links, but haven't seen any problems from them.

```bash
k3s check-config
```

### Deploying NGINX

Now that the cluster is up and running, let's try deploying something! Nginx is a popular reverse proxy we can try. Make sure you pick an image that is built for your hardware (arm is for the Pi). If you grab one of the popular ones like Bitnami's you may get an obscure `exec format error` when running the pod, which tells you the Docker image isn't for your OS.

```bash
helm repo add shubhamtatvamasi https://shubhamtatvamasi.github.io/helm
helm install my-nginx shubhamtatvamasi/nginx --version 0.1.12
```

The directions that dump out after the deploy tell you how to use K8s port forwarding to get access to Nginx from outside.

```powershell
$env:POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=nginx,app.kubernetes.io/instance=my-nginx" -o jsonpath="{.items[0].metadata.name}")
$env:CONTAINER_PORT=$(kubectl get pod --namespace default $env:POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
kubectl --namespace default port-forward $env:POD_NAME 8080:$env:CONTAINER_PORT
```

The `kubectl port-forward` command will block until you Ctrl+C it. So in the browser hit [http://localhost:8080/](http://localhost:8080/) and you should see this:

![nginx](/assets/images/nginx-welcome.png)

## Installing Docker

To build images in Docker on the Pi, you must install it on the server. I chose to install it on my beefier 4B, which is also the main K8s server. I wasn't as lucky with this as I was installing K3s. I tried a few different methods, but kept running into problems. Some may be due to running it as non-root (which seems like the correct thing to do). I finally found this worked.

```bash
# on k3s-server
curl -sSL https://get.docker.com | sh
```

Docker is now running on the server, which is great if we want to use it on the server. To access it from my Windows box, I set up a [Docker context](https://docs.docker.com/engine/context/working-with-contexts/) to point to it.

```powershell
# on Windows
docker context create k3s-server --docker "host=ssh://pi@k3s-server"

# you can now use the context to access Docker on k3s-server
docker ‚Äìcontext k3s-server images

# set k3s-server as the default context
docker context use k3s-server
```

Once that is done, you can build an image from source local source code on the server, which is covered [below](#docker).

## Installing Docker Registry

A [registry](https://docs.docker.com/registry/) is from where you pull the images you want use. [Docker Hub](https://hub.docker.com/) is and example of a public image registries. You can push to a public registry, but in most cases you have to pay to push private images. For my scenario I want it to be self contained (for the most part), so I added a local registry.

I want a local registry so agents can pull images from my private registry.

Like Docker, I installed the Docker Registry on the 4B. The registry itself runs as a Docker container and you simply run the image. `--restart always` will start the registry on reboot.

```bash
# on k3s-server
docker run -d -p 5000:5000 --restart always --name registry registry:2
```

Now that the registry is running, you can push the image you built to it as shown in the ASP.NET example [below](#pushing-the-docker-image).

For workers to be able to pull from the private registry, they need to know about it. In this configuration, the server is also a worker, so it needs this change also. For all nodes, create a file `/etc/rancher/k3s/registries.yaml` and add a mirror entry for the registry server. (You may have to create folders on the worker).

```yaml
mirrors:
  "k3s-server:5000":
    endpoint:
      - "http://k3s-server:5000"
```

## Running an ASP.NET App in the Cluster

It's one thing to pull a Docker image from the hub and deploy it to the K8s cluster, but it's another thing to build and deploy my own images to the cluster.

### Creating the App

For the test app, I used the .NET 6 webapi template (`dotnet new webapi -o dotnet-webapi`). There are only a few changes I had to make to `Program.cs` to help it work better with my cluster.

Since I'm going to run multiple apps in my cluster, I'll use different paths in the URL for each one. To expose the app outside K8s, I created an ingress (see [below](#ingress)) with a non-root path of `/web-api`.

I added these two lines set the base path of the app to `/web-api`. (For .NET 5 you can use `BasePath` in `appsettings.json` but that doesn't work for .NET 6)

```csharp
app.UsePathBase("/web-api");
app.UseRouting();
```

To show Swagger for a release build and avoid dealing with TLS (I'm going to assume it is terminated before we get to K8s), I commented out these lines.

```csharp
//if (app.Environment.IsDevelopment())
...
// app.UseHttpsRedirection();
```

And finally, I added health check endpoints, which I configured in my helm `deployment.yaml` (see next section).

```csharp
app.MapGet("/", () => "dotnet-webapi. Check /web-api/health/live and /web-api/health/ready" );
app.MapGet("/health/ready", () => "ready" );
app.MapGet("/health/live", () => "live" );
```

### Docker

VSCode's Docker extension has a task to add a Dockerfile to the project (Ctrl+Shift+P then type Docker). It gives you a good starting point. I ran it then moved the Dockerfile to `DevOps/Docker` and adjusted the paths since they weren't correct.

Now that I had Docker and a Docker Registry, I created an image. Since my default context was k3s-server, the source files were transferred to it and the image was built on the server.

```powershell
$Tag = '0306a'
$imageName = 'dotnet-webapi'

docker build --rm `
             --tag ${imageName}:$Tag `
             --file ../../DevOps/Docker/Dockerfile `
             .
```

### Pushing the Docker Image

For the K3s nodes to be able to pull the image, it must be pushed to the repository. I used a different tag for each build since I had issues with K3s not pulling an image with the same tag (and why would it?).

```powershell
$Tag = '0306a'
$imageName = 'dotnet-webapi'
$dockerRegistry = 'k3s-server:5000'

docker image tag ${imageName}:$Tag $dockerRegistry/${imageName}:$Tag
docker push $dockerRegistry/${imageName}:$Tag
```

### Creating the Helm Chart

Helm charts make it much easier to maintain K8s manifests. To add helm support to the app, I created a `DevOps` folder and ran this to create a `helm` subfolder with a new chart in it.

```powershell
helm create helm
```

I only needed to changes the `templates/deployment.yaml` file in the chart but changing the port values in `template.spec.containers` from 80 and http to 8080 since I will have the app listen on 8080 (something higher than 1024).

The `values.yaml` file is the file that has the app-specific settings that populate the manifests. See the repo for the full details, but the main changes were for the `repository` and ingress port changes.

### Installing the Helm Chart

Finally I installed the web-api with helm.

```powershell
$valuesFile = ./DevOps/helm/values.yaml
$Tag = '0306a'
$imageName = 'dotnet-webapi'

helm upgrade --install --values $valuesFile $imageName --set', "image.tag=$Tag" . --wait
```

After a minute or two it returned (since I used `--wait`). And could see my weather forcast at [http://k3s-server/web-api/WeatherForecast](http://k3s-server/web-api/WeatherForecast)

### Troubleshooting

Just a few commands if you have problems. [Lens](https://k8slens.dev/) can also help point out issues.

```bash
# watch pods.
kubectl get pod -o wide -w

# look at the bottom for events if the pod isn't healthy
kubectl describe pod <podname>

# show installed charts
helm list

# dump out all the manifests for review
helm get all dotnet-webapi > /temp/webapi.helm
```

The repo's `run.ps1` shows how to do a helm dry run to dump out the manifests for review before deploying.

## The End

This has been alot of words.

## Links

* [Rancher's K3s doc](
https://rancher.com/docs/k3s/latest/en/installation/)
* [Lens](https://k8slens.dev/) Kubernetes Tool
* [Run Kubernetes on your Raspberry Pi cluster with k3s](https://ikarus.sg/kubernetes-with-k3s/) by Will Ho
* [Installing fully-fledged vanilla Kubernetes on Raspberry Pi](https://blog.flant.com/installing-fully-fledged-vanilla-kubernetes-on-raspberry-pi/) from Flant
* [Raspberry Pi Cluster Episode 4 - Minecraft, Pi-hole, Grafana and More!](https://www.jeffgeerling.com/blog/2020/raspberry-pi-cluster-episode-4-minecraft-pi-hole-grafana-and-more) by Jeff Geerling
* [How To Install Docker and Docker-Compose On Raspberry Pi](https://dev.to/elalemanyo/how-to-install-docker-and-docker-compose-on-raspberry-pi-1mo) by Alema√±o
* [Get Started with Docker on Raspberry Pi](https://blog.alexellis.io/getting-started-with-docker-on-raspberry-pi/) by Alex Ellis
